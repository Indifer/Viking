/** @license
 * viking <>
 * Author: indifer | MIT License
 * Email: indifer@126.com|liangyi_z@126.com
 * v0.2.0 (2017/08/11 17:39)
 */
;!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("crossroads")):"function"==typeof define&&define.amd?define("viking",["crossroads"],e):t.viking=e(t.crossroads)}(this,function(t){"use strict";function e(){return this.crossroads=t,this.currentRouteName="",this.currentRoute="",this.currentRefresh=!1,this.lastRoute="",this.lastRouteName="",this.routeType="action",this.controllers={},this.crossroads.bypassed.add(function(t){console.log(t)}),this}e.prototype.defineController=function(t,e){t=this.formatRouteName(t);var o=this,i=(e=e||{}).action,n=e.beforeAction,r=this.crossroads.addRoute(e.route,function(){if("action"===o.routeType){var r=t;o.currentRouteName=r,i.apply(e.action,arguments)}else"beforeAction"===o.routeType&&"function"==typeof n&&n.apply(e.beforeAction,arguments)});e.rules&&(r.rules=e.rules),r.existBeforeAction="function"==typeof e.beforeAction,r.reset=e.reset,r.resize=e.resize,r.destroy=e.destroy,r.init=e.init,r.module=e.module,this.controllers[t]=r},e.prototype.formatRouteName=function(t){return t.indexOf("#")>-1?t.substr(1):t},e.prototype.formatRoute=function(t){return t.indexOf("#")>-1?t.substr(1):t},e.prototype.formatRouteToRouteName=function(t){var e=t.indexOf("#"),o=t.indexOf("?");return t=t.substring(e>-1?e+1:0,o>-1?o:t.length)},e.prototype.getRouteNameByRoute=function(t){t=this.formatRoute(t);for(var e in this.controllers)if(this.controllers[e].match(t))return this.formatRouteName(e);return""},e.prototype.getRouteByParameter=function(t,e){var o=this.controllers[t];return o?o.interpolate(e):""},e.prototype.onRouteChange=function(e){(e=e||!1)&&t.resetState();var o=this.currentRoute.indexOf("#")>-1?this.currentRoute.substr(1):this.currentRoute;t.parse(o)},e.prototype.gotoRoute=function(t,e){this.routeType="action",this.lastRoute=this.currentRoute,this.lastRouteName=this.currentRouteName;var o=t.toLowerCase();this.currentRoute=o,this.onRouteChange(e)},e.prototype.gotoRouteBefore=function(e){this.routeType="beforeAction";var o=e.toLowerCase();o=o.indexOf("#")>-1?o.substr(1):o,t.parse(o),t.resetState()},e.prototype.extend=function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};var o=new e;return o.fn=e.prototype,o}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("viking")):"function"==typeof define&&define.amd?define("viking/util",["viking"],e):e(t.viking)}(this,function(t){"use strict";var e={isNullOrEmpty:function(t){return null===t||void 0===t||""===String.prototype.trim.call(t)},decodeUrlParams:function(t){t=t.split("&");var e,o={};for(var i in t)t.hasOwnProperty(i)&&2===(e=t[i].split("=")).length&&(o[e[0]]=e[1]);return o}};return t.util=e,t.util}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("viking"),require("viking/util")):"function"==typeof define&&define.amd?define("viking/history",["viking","viking/util"],e):e(t.viking,t["viking.util"])}(this,function(t,e){"use strict";function o(){return this._values=[],this}return o.prototype.clear=function(){this._values=[]},o.prototype.count=function(){return this._values.length},o.prototype.last=function(){return this._values.length>0?this._values[this._values.length-1]:null},o.prototype.pop=function(t){var e=[];for(t=t||1;t>0;)this._values.length>0&&e.push(this._values.pop()),t--;return e},o.prototype.add=function(t){return!e.isNullOrEmpty(t)&&(t=t.toString().toLowerCase().trim(),(0===this._values.length||this._values[this._values.length-1]!=t)&&(this._values.push(t),!0))},o.prototype.update=function(t,o){return!(e.isNullOrEmpty(t)||o<0)&&(t=t.toString().toLowerCase().trim(),this._values.length>o&&(this._values[o]=t,!0))},o.prototype.item=function(t){return t<0||t>this._values.length-1?null:this._values[t]},o.prototype.popTo=function(t){if(!e.isNullOrEmpty(t)){var o=this.count();if(o>0)for(var i=o-1;i>=0;i--)if(this.item(i).indexOf(t.toLowerCase())>-1){var n=o-i;return this.pop(n),n}return 0}},o.prototype.index=function(t){if(!e.isNullOrEmpty(t)){var o=this.count();if(o>0)for(var i=o-1;i>=0;i--)if(this.item(i).indexOf(t.toLowerCase())>-1)return o-i;return 0}},t.history=new o,t.history}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("viking"),require("ejs")):"function"==typeof define&&define.amd?define("viking/view",["viking","ejs"],e):e(t.viking,t.ejs)}(this,function(t,e){"use strict";return t.fn.view={},t.view.tempCached=!0,t.view.templates={},t.view.pages={},t.extend(t.fn.view,{define:function(e,o,i){e=t.formatRouteName(e),this.pages[e]={template:o,data:i}},getPage:function(t){var e=this.pages[t];return e?this.render({cache:!1,name:t},e.data):null},render:function(t,o){var i;return"string"==typeof t?i=t:t.name&&(i=this.pages[t.name].template),e.render(i,o)}}),t.view}),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("viking"),require("viking/util"),require("viking/history"),require("viking/view")):"function"==typeof define&&define.amd?define("viking/app",["viking","viking/util","viking/history","viking/view"],e):e(t.viking,t["viking.util"],t["viking.history"],t["viking.view"])}(this,function(t,e,o,i){"use strict";function n(e,o,i,n,r){var s=t.app,u=t.getRouteNameByRoute(e),a=t.currentRouteName;if(s.initPage(u),t.controllers[u].isInit||(t.controllers[u].isInit=!0,"function"==typeof t.controllers[u].init&&t.controllers[u].init()),s.events.onBeforeGoto)for(var l=s.events.onBeforeGoto,f=0;f<l.length;f++)l[f](a,u);i&&"function"==typeof t.controllers[u].reset&&t.controllers[u].reset();t.controllers[u].existBeforeAction&&t.gotoRouteBefore(e.trim()),s.transitionsFlag=2,s.transitions(n,u,a,null,function(){""!==a&&"function"==typeof t.controllers[a].destroy&&(t.controllers[a].destroy(),t.controllers[a].isInit=!1),t.gotoRoute(e.trim()),s.transitionsFlag=0,"function"==typeof r&&r()})}t.fn.app={},t.app.transitionsFlag=0,window.addEventListener("popstate",function(){var i=window.history.state&&window.history.state.toRoute;if(i){var r=t.getRouteNameByRoute(i);if(e.isNullOrEmpty(r))return void setTimeout(function(){t.app.goto(i)},1);var s=t.formatRouteToRouteName(i);o.popTo(s);n(i,0,!1)}(i=window.location.hash)&&t.app.goto(i)});return t.extend(t.fn.app,{events:{},addEvent:function(t,e){this.events[t]=this.events[t]||[],this.events[t].push(e)},beforeGoto:null,transitions:function(t,o,i,n,r){o=o,i=e.isNullOrEmpty(i)?null:i;$(window).width(),$(window).height();switch(n=n||300,t){case"slideLeft":case"slideRight":case"fade":case"none":default:i&&$(document.getElementById(i)).css({left:0,top:0,opacity:1}),$(document.getElementById(o)).css({left:0,top:0,opacity:1});var s={};$(document.getElementById(o)).css(s),i&&($(document.getElementById(i)).css(s),$(document.getElementById(i)).hide()),$(document.getElementById(o)).show(),"function"==typeof r&&r()}},back:function(t,i,n){var r=this,s=o.last();e.isNullOrEmpty(s)?r.homeRoute&&r.goto(r.homeRoute):r.goto(s,!0,t,i)},goto:function(i,r,s,u,a,l){var f=this;if(l=l||!1,!e.isNullOrEmpty(i)&&0==f.transitionsFlag){var p=t.getRouteNameByRoute(i);if(""!=p)if("block"!==$(document.getElementById(p)).css("display")){if(s=null!=s&&"true"===s.toString(),!(r=null!=r&&"true"===r.toString())){var c={toRoute:i};t.currentRoute?(o.add(t.currentRoute),window.history.pushState(c,"",i)):window.history.replaceState(c,"",i)}if(r){var d=o.index(p);if(d>=0)return void window.history.go(-d)}n(i,0,s,u,a)}else f.transitionsFlag=0;else if(f.transitionsFlag=0,!l&&!e.isNullOrEmpty(i)){var h,v=i.indexOf("#");(v=(h=v>-1?i.substr(v+1):i).indexOf("?"))>-1&&(h=h.substr(0,v)),require([(t.app.baseFolder||"")+h],function(t){f.goto(i,r,s,u,a,!0)})}}},initPage:function(t){var e=this,o=$(document.getElementById(t));0==o.length&&i&&i.getPage&&(e.showLoading&&e.showLoading(),o=i.getPage(t),(o=$(o)).attr("id",t),o.attr("vk-role","page"),o.addClass("page"),o.css("display","none"),$("#vk-container").append(o),e.hideLoading&&e.hideLoading())},initApp:function(){if(0===$("#vk-outer").length){var t=$("div");t.attr("id","vk-outer");var e=$("div");e.attr("id","vk-container"),e.addClass("clearfixed"),t.append(e),$("body").children().remove(),$("body").append(t)}},ready:function(t){var o=this;o.initApp(),$("#vk-outer").on("click","[vk-goto]",function(){var t=$(this).attr("vk-goto"),i=$(this).attr("vk-transition"),n=$(this).attr("vk-reset"),r=$(this).attr("vk-back");return r=null!=r&&"true"===r.toString(),e.isNullOrEmpty(t)?r&&o.back(n,i):o.goto(t,r,n,i),!1})}}),t.app});;